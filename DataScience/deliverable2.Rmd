---
title: "Phase 2: Model Planning and Building"
author: "Brendan Allen"
output:
  html_document:
    df_print: paged
---

<style>
body {
text-align: justify}
</style>

####[Home](https://ballen2024.github.io/DataScience/index.html)

####[Phase 1: Discovery and Data Preparation](https://ballen2024.github.io/DataScience/deliverable1.html)

####[Phase 2: Model Planning and Building](https://ballen2024.github.io/DataScience/deliverable2.html)

####[Phase 3: Results and Operationalization](https://ballen2024.github.io/DataScience/deliverable3.html)

###Getting Started
**First we want to import any necessary libraries we will be using.**

**Note: Uncomment the install lines if you haven't yet installed these packages**
```{r warning=FALSE}
suppressMessages(library(tidyr))
suppressMessages(library(dplyr))
# suppressMessages(install.packages("devtools"))
# suppressMessages(devtools::install_github("stefanedwards/lemon"))
suppressMessages(library(lemon))
suppressMessages(library(scales))
suppressMessages(library(tidyverse))
suppressMessages(library(knitr))
suppressMessages(library(stringr))
knit_print.data.frame <- lemon_print
```

**We will want to import all of our work from [Phase 1](https://ballen2024.github.io/DataScience/deliverable1.html) as well.**
```{r  message=FALSE, error=FALSE, warning=FALSE, results='hide'}
purl("deliverable1.Rmd", output = "deliverable1.r")
source("deliverable1.r")
```
###Looking at the Data
The data source [**Baseball Savant**](https://baseballsavant.mlb.com/statcast_search?hfPT=&hfAB=&hfBBT=&hfPR=foul%7C&hfZ=&stadium=&hfBBL=&hfNewZones=&hfGT=R%7C&hfC=&hfSea=2019%7C&hfSit=&player_type=pitcher&hfOuts=&opponent=&pitcher_throws=&batter_stands=&hfSA=&game_date_gt=&game_date_lt=2019-06-05&hfInfield=&team=&position=&hfOutfield=&hfRO=&home_road=&hfFlag=&hfPull=&metric_1=&hfInn=&min_pitches=0&min_results=0&group_by=venue&sort_col=pitches&player_event_sort=h_launch_speed&sort_order=desc&min_pas=0#results) is an MLB affiliate that collects baseball statistics for major league games. The initial data set here `foul_balls` includes **906** observations with **7** variables. The dataset was used originally to observe where the most dangerous foul balls land, which is discussed in depth in [this story](https://fivethirtyeight.com/features/we-watched-906-foul-balls-to-find-out-where-the-most-dangerous-ones-land/). Our `launch_data` set was also collected from this source. I also used [**Baseball Reference**](https://www.baseball-reference.com/leagues/MLB/2016-standings.shtml) to gather data on standings for the 2016 MLB season. Just in my initial investigation, there appeared to be some `NA` data points, so we'll have to clean the data up. I also noticed that there is some inconsistent or inappropriate type formatting, so we'll have to clean that up as well.

####Here is an overview of each dataset

#####`foul_balls`

* __`matchup`__
    + The two teams that played. Formatted like `Atlanta Braves vs New York Mets`. In order to have a merge point for this set and the previous set, I am going to make a lookup table with the team names and their corresponding three character codes.
* __`date`__
    + Date of the most foul-heavy day at each stadium. Formatted like `yyyy-mm-dd`.
* __`hit_type`__
    + Fly, grounder, line drive, pop up or batter hit self. Formated as a string.
* __`velocity`__
    + Recorded exit velocity of each hit -- blank if not provided. Formatted as a double
* __`predicted_zone`__
    + The zone we predicted the foul ball would land in by gauging angles. Formatted as a factor.
* __`camera_zone`__
    + The zone that the foul ball landed in, confirmed by footage. Formatted as a factor.
* __`used_zone`__
    + The zone used for analysis. Formatted as a factor.

#####`launch_data`

* __`date`__
    + Date of the game where this hit was recorded Formatted like `yyyy-mm-dd`.
* __`field`__
    + Field where the game was played. Formatted as string.
* __`home`__
    + Name of home team's 3 character abbreviation. Formatted as a string.
* __`away`__
    + Name of away team's 3 character abbreviation. Formatted as a string.
* __`velocity`__
    + Exit velocity of the ball hit. Formatted as a double.
* __`angle`__
    + Angle of the ball hit in degrees. Formatted as a double.

#####`standings`

* __`rank`__
    + Team rank overall. Formatted as a double
* __`team`__
    + Team name's 3 character abbreviation
* __`games`__
    + Total number of games played. Formatted as a double.
* __`wins`__
    + Total number of games won. Formatted as a double.
* __`losses`__
    + Total number of games lost. Formatted as a double.
* __`run_diff`__
    + Run differential (average runs scored - average runs allowed). Formatted as a double.


**Let's read in our new data on foul balls**
```{r, warning=FALSE}
foul_balls <- suppressMessages(read_csv("https://raw.githubusercontent.com/fivethirtyeight/data/master/foul-balls/foul-balls.csv"))
launch_data <- suppressMessages(read_csv("./savant_data.csv"))
standings <- suppressMessages(read_csv("./standings.csv"))

```


**We'll want to clean up our data now**

In this block, I filtered our initial game data (`game_data`) to only include games from 1990-2016; omitted the missing data from our original foul balls data (`foul_balls`) from the article and our new foul ball data (`launch_data`) from the 2016 season; and narrowed our data selection in all of our sets. I'll go into greater detail on these selected variables.
```{r}
game_data <- game_data %>%
  filter(date >= 19900101)

foul_balls <- foul_balls %>%
  na.omit()

launch_data <- launch_data %>%
  select(c(game_date, player_name, home_team, away_team, launch_speed, launch_angle)) %>%
  filter(launch_speed != "null", launch_angle != "null")

standings <- standings %>%
  select(c(Rk, Tm, G, W, L, Rdiff))
```

**I wanted to rename the columns of our sets too**
```{r}
game_data <- game_data %>%
  rename(away=v_name, home=h_name)

foul_balls <- foul_balls %>%
  rename(date = game_date, hit_type = type_of_hit, velocity = exit_velocity)

launch_data <- launch_data %>%
  rename(date=game_date, field=player_name, home=home_team, away=away_team, velocty=launch_speed, angle=launch_angle)

standings <- standings %>%
  rename(rank=Rk, team=Tm, games=G, wins=W, losses=L, run_diff=Rdiff)

new<-game_data
```

**Now we need to standardize the formatting of our variables**

Here we converted the dates to an actual date format, made our foul ball zones factors, and our velocity and angle to a numeric type instead of a character.
```{r}
game_data$date <- as.character(game_data$date)
game_data$date <- as.Date(game_data$date, format="%Y%m%d")

foul_balls$predicted_zone <- as.factor(foul_balls$predicted_zone)
foul_balls$camera_zone <- as.factor(foul_balls$camera_zone)
foul_balls$used_zone <- as.factor(foul_balls$used_zone)

launch_data$velocty <- as.double(launch_data$velocty)
launch_data$angle <- as.double(launch_data$angle)

```

**To finalize cleaning our data, we need to do some work on the `matchup` column of our `foul_balls` data**

Specifically the matchup is formatted like `Atlanta Braves vs New York Mets`. We want to offer consistency with our other data sets, so we are going to split this `matchup` into `home` and `away`. We'll need to make a lookup table though to convert the full team name into it's 3 character abbreviation. I just created my own csv file for [this](https://github.com/ballen2024/ballen2024.github.io/blob/master/DataScience/teams.csv) in an editor, so we'll have to load that.
```{r}
teams <- suppressMessages(read_csv("./teams.csv"))
```

Using regular expresions in `R`, we can split up the `matchup`'s into their `home` and `away` teams. We will want to grab everything in the string until we encounter "vs" or "VS" and store that as `away` team, since American convention holds that matchups are written as *away vs home*. We can throw away the "vs" or "VS" and then we can grab the second string and store it as the `home` team.

After a lot of trial an error to match the abbreviations to the full names in the `foul_balls` set, I finally realized the their was some unnoticed spaces at the front of the home teams and at the back of the away teams. This happened because of the way I used `str_split()`. I believe you could eat the whitespace, but I instead decided to add some spaces to the team names in the lookup table.

```{r}
split <- str_split(foul_balls$matchup, "(vs|VS)")
mat <- matrix(unlist(split), ncol=2, byrow=TRUE)
matchup <- as.data.frame(mat)
foul_balls$home <- as.character(matchup$V2)
foul_balls$away <- as.character(matchup$V1)

teams$space_front <- paste("", teams$full)
teams$space_back <- paste(teams$full, "")
foul_balls$home <- teams[match(foul_balls$home, teams$space_front), "abb"]
foul_balls$away <- teams[match(foul_balls$away, teams$space_back), "abb"]
```


